<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Take Down Cancer Raffle | SAWA</title>

  <style>
    :root{
      --bg1:#f6f8fc;
      --bg2:#eef3fb;

      --card:#ffffff;
      --stroke:rgba(15, 23, 42, 0.10);

      --text:#0f172a;
      --muted:#475569;

      --blue:#1b3a6b;
      --red:#c81f2d;

      --paidDeep:#0b6b2a;
      --paidDeepBg:rgba(11,107,42,0.18);

      --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      --radius: 18px;
    }

    *, *::before, *::after { box-sizing: border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 450px at 15% 0%, rgba(27,58,107,0.08), transparent 55%),
        radial-gradient(900px 450px at 85% 0%, rgba(200,31,45,0.08), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }

    .wrap{ max-width:1100px; margin:0 auto; padding:20px; }

    .hero-banner{
      width:100%;
      border-radius: var(--radius);
      overflow:hidden;
      margin-bottom:14px;
      box-shadow: var(--shadow);
    }
    .hero-banner img{
      width:100%;
      height:auto;
      display:block;
    }

    .topbar{
      display:flex;
      align-items:center;
      gap:16px;
      padding:14px 16px;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(90deg, rgba(27,58,107,0.06), rgba(200,31,45,0.05));
      box-shadow: var(--shadow);
      margin-bottom: 14px;
    }
    .topbar img{ height:46px; width:auto; display:block; }

    .prize-card{
      text-align:center;
    }
    .prize-card img{
      max-width:100%;
      height:auto;
      border-radius:14px;
      margin-bottom:12px;
    }
    .prize-title{
      font-size:20px;
      font-weight:900;
      color:var(--blue);
      margin:0 0 8px;
    }
    .prize-value{
      font-size:28px;
      font-weight:1000;
      color:var(--red);
      margin:8px 0;
    }
    .topbar h1{ font-size:24px; margin:0; line-height:1.1; }
    .topbar .sub{ margin:4px 0 0; color:var(--muted); font-size:13px; }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
      margin-bottom:14px;
    }

    h2{ margin:0 0 10px; font-size:18px; }
    p{ margin: 8px 0; color:var(--muted); line-height:1.45; }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    .pillbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--stroke);
      color:var(--muted);
      font-weight:900; font-size:12px;
      background:#fff;
    }
    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    .dot.green{ background: rgba(11,107,42,0.92); }
    .dot.blue{ background: rgba(27,58,107,0.70); }
    .dot.red{ background: rgba(200,31,45,0.70); }

    .hr{ height:1px; background: rgba(15,23,42,0.10); margin:14px 0; }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:12px 0 6px;
      font-weight:800;
    }
    input, select, textarea{
      width:100%;
      max-width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(15, 23, 42, 0.14);
      background:#ffffff;
      color:var(--text);
      outline:none;
      font-size:15px;
    }
    textarea{ min-height:110px; resize:vertical; }

    input:focus, select:focus, textarea:focus{
      border-color: rgba(27,58,107,0.45);
      box-shadow: 0 0 0 4px rgba(27,58,107,0.12);
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 700px){ .row{ grid-template-columns:1fr; } }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(15, 23, 42, 0.14);
      background:#fff;
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
      text-decoration:none;
      width:100%;
    }
    .btn:hover{ background: rgba(15, 23, 42, 0.03); }

    .btn-blue{
      border-color: rgba(27,58,107,0.28);
      background: linear-gradient(180deg, rgba(27,58,107,0.10), rgba(27,58,107,0.06));
    }
    .btn-red{
      border-color: rgba(200,31,45,0.28);
      background: linear-gradient(180deg, rgba(200,31,45,0.10), rgba(200,31,45,0.06));
    }
    .btn-primary{
      border-color: rgba(27,58,107,0.35);
      background: linear-gradient(180deg, rgba(27,58,107,0.14), rgba(27,58,107,0.08));
      font-size:16px;
      padding:14px 14px;
    }

    .notice{
      border:1px solid rgba(27,58,107,0.18);
      background: rgba(27,58,107,0.06);
      border-radius:16px;
      padding:12px;
      color:var(--text);
    }

    .qrgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .qrbox{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px;
      background:#fff;
      text-align:center;
    }
    .qrbox img{
      width:100%;
      height:auto;
      border-radius:12px;
      display:block;
      border:1px solid rgba(15,23,42,0.10);
    }
    .qrlabel{
      font-weight:900;
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
      letter-spacing:0.2px;
      text-transform:uppercase;
    }

    .ok{ color:#16a34a; font-weight:900; }
    .err{ color:#dc2626; font-weight:900; }
    .muted{ color:var(--muted); }

    /* tickets */
    .ticketGrid{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
    }
    @media (max-width: 980px){ .ticketGrid{ grid-template-columns: repeat(4, 1fr); } }
    @media (max-width: 600px){ .ticketGrid{ grid-template-columns: repeat(3, 1fr); } }

    .ticket{
      border:1px solid rgba(15,23,42,0.10);
      border-radius:14px;
      padding:10px;
      background:#fff;
      position:relative;
      overflow:hidden;
      box-shadow:
        0 0 0 2px rgba(11,107,42,0.22),
        0 0 14px rgba(11,107,42,0.28),
        0 0 26px rgba(11,107,42,0.14);
    }
    .ticket::before{
      content:"";
      position:absolute;
      inset:0;
      background: var(--paidDeepBg);
      opacity: 0.7;
      pointer-events:none;
    }
    .ticketInner{ position:relative; }
    .ticketNo{
      font-weight:1000;
      font-size:16px;
      color: var(--paidDeep);
      letter-spacing:0.3px;
    }
    .ticketName{
      margin-top:4px;
      font-weight:900;
      color: rgba(15,23,42,0.86);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Hero Banner -->
    <div class="hero-banner">
      <img src="https://www.shalerareawrestling.com/assets/tdc/TDC_Header.png" alt="Take Down Cancer - One Team. One Fight." />
    </div>

    <div class="topbar">
      <!-- Update these image paths to match your repo -->
      <img src="https://www.shalerareawrestling.com/assets/saw.png" alt="SA Wrestling" />
      <div>
        <h1>Take Down Cancer Night — Raffle</h1>
        <div class="sub">
          Sponsored by <b>Shaler Area HS &amp; MS Wrestling Association (SAWA)</b> • Digital ticket ledger (no physical ticket needed)
        </div>
      </div>
    </div>

    <!-- Top: confirmed tickets -->
    <div class="card">
      <div class="pillbar" style="justify-content:space-between; margin-bottom:10px;">
        <div class="pillbar">
          <span class="pill"><span class="dot green"></span>Confirmed (Paid) Tickets</span>
          <span class="pill"><span class="dot blue"></span>Your tickets appear here once confirmed</span>
        </div>
        <span class="pill" id="meta">Loading…</span>
      </div>

      <p class="muted" id="statusText">Loading confirmed tickets…</p>
      <div class="hr"></div>

      <div id="ticketGrid" class="ticketGrid"></div>
    </div>

    <div class="grid">
      <!-- Left: request -->
      <div class="card">
        <h2>Purchase Raffle Tickets</h2>

        <div class="pillbar">
          <span class="pill"><span class="dot red"></span>Support our wrestlers</span>
          <span class="pill"><span class="dot blue"></span>Digital ticket receipt</span>
        </div>

        <div class="hr"></div>

        <div class="row">
          <a class="btn btn-blue" id="venmoBtn" href="#" target="_blank" rel="noopener">Pay via Venmo: @SAWATitans</a>
          <a class="btn btn-red" id="paypalBtn" href="#" target="_blank" rel="noopener">Pay via PayPal: @SAWATitans</a>
        </div>

        <p class="notice" style="margin-top:12px;">
          <b>Memo line:</b> Put <b>TDC Raffle</b> in the memo so we can match your payment.
        </p>

        <div class="qrgrid">
          <div class="qrbox">
            <img src="https://www.shalerareawrestling.com/assets/tdc/venmo_sawa.jpg" alt="Venmo QR" />
            <div class="qrlabel">Venmo QR</div>
          </div>
          <div class="qrbox">
            <img src="https://www.shalerareawrestling.com/assets/tdc/paypal_sawa.jpg" alt="PayPal QR" />
            <div class="qrlabel">PayPal QR</div>
          </div>
        </div>

        <div class="hr"></div>

        <form id="reqForm">
          <label>Your name</label>
          <input id="name" placeholder="First + Last" autocomplete="name" required />

          <label>Contact (email or phone)</label>
          <input id="contact" placeholder="So we can confirm your tickets" required />

          <div class="row">
            <div>
              <label>How many tickets?</label>
              <input id="qty" type="number" min="1" step="1" value="1" required />
            </div>
            <div>
              <label>Payment method</label>
              <select id="payMethod" required>
                <option value="venmo">Venmo</option>
                <option value="paypal">PayPal</option>
                <option value="cash">Cash / Other</option>
              </select>
            </div>
          </div>

          <label>Notes (optional)</label>
          <textarea id="note" placeholder="Anything we should know?"></textarea>

          <button class="btn btn-primary" type="submit" style="margin-top:12px;">Submit Ticket Request</button>
          <div id="msg" style="margin-top:10px;"></div>
        </form>
      </div>

      <!-- Right column -->
      <div>
        <!-- Prize Card -->
        <div class="card prize-card">
          <h2>Grand Prize</h2>
          <img src="https://www.shalerareawrestling.com/assets/tdc/TDC_Prize.png" alt="TV and Soundbar Prize" />
          <p class="prize-title">TV &amp; Home Entertainment System</p>
          <p class="prize-value">$1000+ Value!</p>
          <p class="muted">Winner will be drawn at the District 7 - Junior High Tournament at Shaler Area High School on 2/14 @ 2pm. We will livestream the raffle drawing on our facebook page. Must be present or reachable to claim.</p>
        </div>

        <!-- How it works -->
        <div class="card">
          <h2>How this works</h2>
        <p>
          1) Pay via Venmo/PayPal (memo: <b>TDC Raffle</b>)<br/>
          2) Submit your request here<br/>
          3) Once payment is confirmed, your ticket(s) appear above as your <b>digital receipt</b>.
        </p>
        <div class="hr"></div>
        <p class="muted">
          Privacy: the public list shows <b>first name + last initial</b> only.
        </p>
        <div class="hr"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase v10 modular SDK (no build step)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, where, orderBy, limit, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ✅ Your Firebase configuration (provided)
    const firebaseConfig = {
      apiKey: "AIzaSyDiXKDy1Xg_W7BNzO-bo1FbapXt_hJTYco",
      authDomain: "tdc-raffle.firebaseapp.com",
      projectId: "tdc-raffle",
      storageBucket: "tdc-raffle.firebasestorage.app",
      messagingSenderId: "832529502371",
      appId: "1:832529502371:web:7f35743f8be7774c736f16"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Payment links (adjust if you want deep links or custom URLs)
    document.getElementById("venmoBtn").href = "https://venmo.com/SAWATitans";
    document.getElementById("paypalBtn").href = "https://paypal.me/SAWATitans";

    const meta = document.getElementById("meta");
    const statusText = document.getElementById("statusText");
    const ticketGrid = document.getElementById("ticketGrid");

    const form = document.getElementById("reqForm");
    const msg = document.getElementById("msg");

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function setMessage(type, text) {
      const cls = type === "ok" ? "ok" : (type === "err" ? "err" : "muted");
      msg.innerHTML = `<div class="${cls}">${escapeHtml(text)}</div>`;
    }

    function maskName(full) {
      // "Daniel Emmons" -> "Daniel E."
      const parts = String(full || "").trim().split(/\s+/).filter(Boolean);
      if (!parts.length) return "";
      if (parts.length === 1) return parts[0];
      return parts[0] + " " + parts[1][0].toUpperCase() + ".";
    }

    function ticketLabelFromId(docId) {
      // short, readable pseudo-ticket number from doc id
      return "#" + String(docId).slice(-6).toUpperCase();
    }

    function renderTickets(rows) {
      const count = rows.length;
      meta.textContent = `${count} confirmed ticket${count === 1 ? "" : "s"}`;

      if (!count) {
        statusText.textContent = "No confirmed tickets yet — be the first!";
        ticketGrid.innerHTML = "";
        return;
      }

      statusText.textContent = "Confirmed tickets (paid) — your digital ticket receipt.";
      ticketGrid.innerHTML = rows.map(r => `
        <div class="ticket" title="Confirmed ticket">
          <div class="ticketInner">
            <div class="ticketNo">${escapeHtml(r.ticketNo)}</div>
            <div class="ticketName">${escapeHtml(r.displayName)}</div>
          </div>
        </div>
      `).join("");
    }

    async function loadConfirmedTickets() {
      try {
        const q = query(
          collection(db, "tdc_raffle_tickets"),
          where("status", "==", "confirmed"),
          orderBy("createdAt", "asc"),
          limit(300)
        );

        const snap = await getDocs(q);
        const rows = snap.docs.map(d => {
          const data = d.data() || {};
          return {
            ticketNo: ticketLabelFromId(d.id),
            displayName: data.displayName || maskName(data.name || "")
          };
        });

        renderTickets(rows);
      } catch (e) {
        console.error(e);
        meta.textContent = "Unavailable";
        statusText.textContent = "Ticket list currently unavailable.";
        ticketGrid.innerHTML = "";
      }
    }

    async function boot() {
      // Silent auth so Firestore rules can require request.auth != null
      try {
        await signInAnonymously(auth);
      } catch (e) {
        console.error(e);
        setMessage("err", "Could not initialize (auth). Enable Anonymous Auth + add your GitHub domain to Authorized Domains.");
        return;
      }

      await loadConfirmedTickets();
      setInterval(loadConfirmedTickets, 30000);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      setMessage("muted", "Submitting…");

      const name = document.getElementById("name").value.trim();
      const contact = document.getElementById("contact").value.trim();
      const qty = parseInt(document.getElementById("qty").value, 10);
      const payment_method = document.getElementById("payMethod").value;
      const note = document.getElementById("note").value.trim();

      if (!name || !contact || !Number.isFinite(qty) || qty <= 0 || qty > 200) {
        setMessage("err", "Please enter your name, contact, and a valid ticket quantity.");
        return;
      }

      try {
        const colRef = collection(db, "tdc_raffle_tickets");
        const displayName = maskName(name);

        // One doc per ticket => each doc id becomes a digital ticket number
        for (let i = 0; i < qty; i++) {
          await addDoc(colRef, {
            name,
            displayName,
            contact,
            payment_method,
            status: "requested",
            note: note || null,
            createdAt: serverTimestamp()
          });
        }

        setMessage("ok", "Request received! Once payment is confirmed, your ticket(s) will appear at the top.");
        form.reset();
        document.getElementById("qty").value = 1;
      } catch (e) {
        console.error(e);
        setMessage("err", "Could not submit request. Check Firestore rules and that Anonymous Auth is enabled.");
      }
    });

    boot();
  </script>
</body>
</html>
